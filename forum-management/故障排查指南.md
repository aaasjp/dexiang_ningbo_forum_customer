# 操作记录功能故障排查指南

## 问题描述
点击操作记录按钮后，没有触发接口请求。

## 排查步骤

### 1. 检查浏览器控制台

打开浏览器开发者工具（F12），查看以下内容：

#### Console 标签页
应该看到以下日志（如果功能正常）：
```
Logs.vue - 打开弹框
Logs.vue - logsDialogVisible: true
LogsDialog - modelValue 变化: true
LogsDialog - 开始加载数据
fetchLogsList - 开始请求
fetchLogsList - 请求参数: {page: 1, page_size: 10}
fetchLogsList - 响应数据: {code: 200, message: "success", data: {...}}
```

如果没有看到这些日志，或者在某一步中断，请记录下来。

#### Network 标签页
应该看到以下请求：
- **请求 URL**: `http://10.129.114.106:8000/api/admin/logs/list?page=1&page_size=10`
- **请求方法**: GET
- **状态码**: 200

如果看到错误状态码：
- **404**: 接口路径不存在
- **403**: 权限不足
- **500**: 服务器错误

### 2. 使用 API 测试页面

直接访问测试页面来验证 API 是否可用：

```
http://localhost:5173/logs-test
```

点击"测试 API 调用"按钮，查看返回结果。

### 3. 检查后端服务

确认后端服务是否正常运行：

```bash
# 使用 curl 测试接口
curl -X GET "http://10.129.114.106:8000/api/admin/logs/list?page=1&page_size=10" \
  -H "gw_session: appid=500883957,name=张三,depatment=人力资源部,orgId=2,jobTitle=管理员, gender=2, status=1,jobNo=staff001"
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [...],
    "total": 100
  }
}
```

### 4. 常见问题及解决方案

#### 问题 1: 弹框没有打开
**症状**: 点击按钮后没有任何反应

**排查**:
1. 检查控制台是否有 JavaScript 错误
2. 检查是否看到 "Logs.vue - 打开弹框" 日志

**解决**:
- 清除浏览器缓存并刷新（Ctrl/Cmd + Shift + R）
- 重启开发服务器（`npm run dev`）

#### 问题 2: 弹框打开但没有请求
**症状**: 弹框显示但表格为空，没有 loading 状态

**排查**:
1. 检查是否看到 "LogsDialog - modelValue 变化" 日志
2. 检查是否看到 "fetchLogsList - 开始请求" 日志

**可能原因**:
- watch 没有正确触发
- 组件导入有问题

**解决**:
```vue
<!-- 确认 LogsDialog 组件正确导入 -->
<script setup>
import LogsDialog from '@/components/LogsDialog.vue'
</script>
```

#### 问题 3: 发起请求但失败
**症状**: 看到请求日志但返回错误

**排查**:
1. 检查 Network 标签页的请求详情
2. 查看响应状态码和返回内容

**可能原因及解决**:

##### 404 Not Found
- **原因**: API 路径不正确
- **检查**: `/admin/logs/list` 路径是否正确
- **解决**: 确认后端 API 路由配置

##### 403 Forbidden
- **原因**: 权限不足或 session 无效
- **检查**: `gw_session` header 是否正确
- **解决**: 检查 `src/utils/request.js` 中的 session 配置

##### 500 Internal Server Error
- **原因**: 后端服务错误
- **检查**: 后端日志
- **解决**: 联系后端开发人员

##### Network Error / ERR_CONNECTION_REFUSED
- **原因**: 后端服务未启动或地址不正确
- **检查**: 后端服务是否运行在 `http://10.129.114.106:8000`
- **解决**: 启动后端服务或更新 `baseURL`

#### 问题 4: CORS 跨域问题
**症状**: 控制台显示 CORS policy 错误

**解决**:
1. 确认后端服务器配置了正确的 CORS 头
2. 或使用代理（在 `vite.config.js` 中配置）

```javascript
// vite.config.js
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://10.129.114.106:8000',
        changeOrigin: true
      }
    }
  }
}
```

### 5. 完整的诊断检查清单

- [ ] 浏览器控制台没有 JavaScript 错误
- [ ] 看到 "Logs.vue - 打开弹框" 日志
- [ ] 看到 "LogsDialog - modelValue 变化: true" 日志
- [ ] 看到 "LogsDialog - 开始加载数据" 日志
- [ ] 看到 "fetchLogsList - 开始请求" 日志
- [ ] Network 标签页有 GET 请求到 `/api/admin/logs/list`
- [ ] 请求返回 200 状态码
- [ ] 看到 "fetchLogsList - 响应数据" 日志
- [ ] 表格显示数据

### 6. 调试代码位置

如需进一步调试，关键代码位置：

1. **页面组件**: `/src/views/Logs.vue` (第 41-45 行)
2. **弹框组件**: `/src/components/LogsDialog.vue` (第 118-127 行)
3. **数据获取**: `/src/components/LogsDialog.vue` (第 170-203 行)
4. **API 调用**: `/src/api/logs.js` (第 13-19 行)
5. **请求配置**: `/src/utils/request.js` (第 6-14 行)

### 7. 快速验证命令

在浏览器控制台运行以下代码快速测试：

```javascript
// 测试 API 调用
import('@/api/logs').then(module => {
  module.getLogsList({page: 1, page_size: 10})
    .then(res => console.log('成功:', res))
    .catch(err => console.error('失败:', err))
})
```

### 8. 临时解决方案

如果仍然无法解决，可以尝试：

1. **使用测试页面**: 访问 `/logs-test` 进行独立测试
2. **检查其他页面**: 访问 `/users` 或 `/points` 看其他 API 调用是否正常
3. **降级测试**: 暂时使用模拟数据

```javascript
// 在 LogsDialog.vue 中临时添加模拟数据
const fetchLogsList = async () => {
  // 临时模拟数据
  logsList.value = [
    {
      log_id: 1,
      user_code: '001',
      user_name: '张三',
      operation_type: 'question_delete',
      content: '删除问题：测试问题',
      ip_address: '192.168.1.1',
      create_time: '2024-01-01T10:00:00'
    }
  ]
  total.value = 1
  return
  
  // 原有代码...
}
```

### 9. 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 浏览器控制台的完整日志（Console）
2. Network 标签页的请求详情（包括请求头、响应头、响应内容）
3. 后端服务的状态和日志
4. 使用的浏览器和版本
5. Node.js 和 npm 版本

---

## 附录：完整的请求流程

```
用户点击按钮
    ↓
Logs.vue: openLogsDialog()
    ↓
logsDialogVisible.value = true
    ↓
LogsDialog.vue: watch(modelValue)
    ↓
resetSearch() + fetchLogsList()
    ↓
api/logs.js: getLogsList(params)
    ↓
utils/request.js: axios.get()
    ↓
后端服务: GET /api/admin/logs/list
    ↓
响应数据
    ↓
LogsDialog.vue: 处理并显示数据
```

每一步都应该有对应的日志输出。找到中断的位置就能定位问题所在。



