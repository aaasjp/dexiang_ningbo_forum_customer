<template>
  <div class="topic-page">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
      <div class="header-title">è¯é¢˜å¹¿åœº</div>
    </div>

    <!-- æœç´¢æ  -->
    <div class="search-bar">
      <el-icon class="search-icon" :size="18">
        <Search />
      </el-icon>
      <input 
        type="text" 
        placeholder="æœç´¢è¯é¢˜" 
        v-model="searchKeyword"
        @input="handleSearch"
      />
    </div>

    <!-- è¯é¢˜åˆ—è¡¨ - ä½¿ç”¨æ— é™æ»šåŠ¨ -->
    <InfiniteScroll
      :loading="loading"
      :no-more="noMore"
      :is-empty="isEmpty"
      :enable-pull-refresh="true"
      empty-text="æœªæ‰¾åˆ°ç›¸å…³è¯é¢˜"
      empty-icon="ğŸ”"
      @load-more="loadMore"
      @refresh="refresh"
    >
      <div class="content">
        <div 
          class="topic-item" 
          v-for="(topic, index) in displayTopics" 
          :key="topic.topic_id" 
          @click="goToDetail(topic.topic_id)"
        >
          <!-- æ’åæ ‡è¯† -->
          <div class="topic-rank">
            <div 
              class="rank-badge"
              :class="{
                'rank-1': index === 0,
                'rank-2': index === 1,
                'rank-3': index === 2,
                'rank-other': index >= 3
              }"
            >
              {{ index + 1 }}
            </div>
          </div>

          <!-- è¯é¢˜ä¿¡æ¯ -->
          <div class="topic-info">
            <div class="topic-name">#{{ topic.title }}</div>
          </div>

          <!-- å‚ä¸æ•°é‡ -->
          <div class="topic-stats">
            {{ formatCount(topic.question_count) }}å‚ä¸
          </div>
        </div>
      </div>
    </InfiniteScroll>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'
import { Search } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'
import InfiniteScroll from '../../components/common/InfiniteScroll.vue'
import { getTopicList } from '../../api/topic'
import type { Topic } from '../../api/topic'
import { useInfiniteScroll } from '../../composables/useInfiniteScroll'

const router = useRouter()

// æœç´¢å…³é”®è¯
const searchKeyword = ref('')

// ä½¿ç”¨æ— é™æ»šåŠ¨ Hook
const {
  list: allTopics,
  loading,
  isEmpty,
  noMore,
  loadMore,
  refresh
} = useInfiniteScroll<Topic>(
  async (page, pageSize) => {
    return await getTopicList(page, pageSize)
  },
  {
    pageSize: 20
  }
)

// æ˜¾ç¤ºçš„è¯é¢˜åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢è¿‡æ»¤ï¼‰
const displayTopics = computed(() => {
  if (!searchKeyword.value.trim()) {
    return allTopics.value
  }
  return allTopics.value.filter(topic =>
    topic.title.toLowerCase().includes(searchKeyword.value.toLowerCase()) ||
    topic.description?.toLowerCase().includes(searchKeyword.value.toLowerCase())
  )
})

// æ ¼å¼åŒ–æ•°å­—
const formatCount = (count: number): string => {
  if (count >= 10000) {
    return (count / 10000).toFixed(1) + 'w'
  } else if (count >= 1000) {
    return (count / 1000).toFixed(1) + 'k'
  }
  return count.toString()
}

// æœç´¢å¤„ç†
const handleSearch = () => {
  // æœç´¢é€»è¾‘å·²é€šè¿‡ computed å®ç°
}

// è·³è½¬åˆ°è¯é¢˜è¯¦æƒ…
const goToDetail = (id: number) => {
  router.push(`/topic/${id}`)
}

// åˆå§‹åŠ è½½
onMounted(() => {
  refresh()
})
</script>

<style scoped>
/* æ ·å¼ä¿æŒä¸å˜ */
</style>

